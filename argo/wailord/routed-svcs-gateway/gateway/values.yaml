pod-gateway:
  image:
    repository: ghcr.io/angelnu/pod-gateway
    # I am using dev version for testing - others should be using latest
    tag: v1.8.1
  webhook:
    image:
      repository: ghcr.io/angelnu/gateway-admision-controller
      tag: v3.9.0

  DNS: 172.16.0.1

  securityContext:
    privileged: true
    capabilities:
      add:
      - NET_ADMIN

  settings:
    # -- If using a VPN, interface name created by it
    VPN_INTERFACE: wg0
    # -- Prevent non VPN traffic to leave the gateway
    #VPN_BLOCK_OTHER_TRAFFIC: true
    # -- If VPN_BLOCK_OTHER_TRAFFIC is true, allow VPN traffic over this port
    VPN_TRAFFIC_PORT: 51820
    # -- Traffic to these IPs will be send through the K8S gateway
    VPN_LOCAL_CIDRS: "10.233.0.0/16 192.168.0.0/16"
    # -- IPs not sent to the POD gateway but to the default K8S.
    NOT_ROUTED_TO_GATEWAY_CIDRS: "10.233.0.0/16 169.254.0.0/16"

    # -- Vxlan ID to use
    VXLAN_ID: 42
    # -- VXLAN needs an /24 IP range not conflicting with K8S and local IP ranges
    VXLAN_IP_NETWORK: "172.16.0"
    # -- Keep a range of IPs for static assignment in nat.conf
    VXLAN_GATEWAY_FIRST_DYNAMIC_IP: 20

    # -- DNS queries to these domains will be resolved by K8S DNS instead of
    # the default (typcally the VPN client changes it)
    DNS_LOCAL_CIDRS: "local"
    #K8S_DNS_IPS: "10.64.0.1"

  # -- settings to expose ports, usually through a VPN provider.
  # NOTE: if you change it you will need to manually restart the gateway POD
  publicPorts:
  - hostname: flood-public
    IP: 13
    ports:
    - type: udp
      port: 56093
    - type: tcp
      port: 56093

  addons:
    vpn:
      enabled: true
      type: gluetun
      gluetun:
        image:
          repository: docker.io/qmcgaw/gluetun
          tag: v3.36.0

      env:
      - name:  VPN_SERVICE_PROVIDER
        value: mullvad
      - name:  VPN_TYPE
        value: wireguard
      - name:  VPN_INTERFACE
        value: wg0
      - name: SERVER_CITIES
        value: Amsterdam
      - name: FIREWALL_VPN_INPUT_PORTS
        value: 56093

# If we need to disable the firewall, this is how
      - name:  FIREWALL
        value: "off"
# If we end up having DNS issues we can bypass with this 
      - name:  DOT
        value: "off"
      
      envFrom:
        - secretRef:
            name: mulvad-creds

      securityContext:
        privileged: true
        capabilities:
          add:
          - NET_ADMIN

      livenessProbe:
        exec:
          command:
            - sh
            - -c
            - if [ $(wget -q -O- https://am.i.mullvad.net/city) == 'Amsterdam' ]; then exit 0; else exit $?; fi
        initialDelaySeconds: 30
        periodSeconds: 60
        failureThreshold: 3

      networkPolicy:
        enabled: true
        egress:
          - to:
            # Run any traffic out through the vpn
            - ipBlock:
                cidr: 0.0.0.0/0
            ports:
            # VPN traffic
            - port: 51820
              protocol: UDP
            # Unless it's cluster traffic
          - to:
            - ipBlock:
                cidr: 10.233.0.0/16
          - to:
            - ipBlock:
                cidr: 192.168.0.0/16
          - to:
            - ipBlock:
                cidr: 169.254.25.10/32

  routed_namespaces:
  - routed-svcs
