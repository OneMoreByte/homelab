apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
data:
  service.webhook.discord_webhook: |
    url: $discord-webhook
    headers:
    - name: Content-Type
      value: application/json

  trigger.sync-status: |
    - when: app.status.sync.status == 'Synced'
      send: [app-sync-succeeded]
      on: sync.status.changed
    - when: app.status.sync.status == 'OutOfSync' || app.status.operationState.phase in ['Error']
      send: [app-sync-failed]
      on: (sync.status.changed || operation.changed)
    - when: app.status.operationState.phase in ['Running'] && app.status.operationState.startedAt < timestamp() - hours(2)
      send: [app-sync-stuck]
      on: time.changed
      oncePer: 1d
    - when: app.status.health.status == 'Degraded'
      send: [app-degraded]
      on: health.status.changed

  template.app-sync-succeeded: |
    webhook:
      method: POST
      body: |
        {"content": "✅ Application **{{.app.metadata.name}}** has been successfully synced."}

  template.app-sync-failed: |
    webhook:
      method: POST
      body: |
        {"content": "❌ Application **{{.app.metadata.name}}** failed to sync!\nStatus: {{.app.status.sync.status}}"}

  template.app-sync-stuck: |
    webhook:
      method: POST
      body: |
        {"content": "⚠️ Application **{{.app.metadata.name}}** has been stuck in progress for over 2 hours\nStarted at: {{.app.status.operationState.startedAt}}"}

  template.app-degraded: |
    webhook:
      method: POST
      body: |
        {"content": "🔥 Application **{{.app.metadata.name}}** is in a degraded state!\nHealth Status: {{.app.status.health.status}}\nMessage: {{.app.status.health.message}}"}
