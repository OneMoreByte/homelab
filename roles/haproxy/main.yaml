- name: install/upgrade haproxy and letsencrypt
  dnf:
    name: 
      - haproxy
      - certbot
      - certbot-dns-route53
    state: latest

- name: Make sure haproxy is shut down for maintenance 
  ansible.builtin.systemd:
    name: haproxy.service
    state: stopped  

- name: Install haproxy config
  ansible.builtin.template:
    src: ./templates/haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    owner: root
    group: root
    mode: '0644'

- name: Create extra directory required for rsyslog
  ansible.builtin.file:
    path: /var/lib/haproxy/dev
    state: directory
    mode: '0755'

- name: Add haproxy config to rsyslog
  ansible.builtin.copy:
    src: resources/haproxy/99-haproxy.conf
    dest: /etc/rsyslog.d/99-haproxy.conf
    owner: root
    group: root
    mode: '0644'

# TODO: Maybe add SELinux stuff?

- name: Install cert renewal script
  ansible.builtin.template:
    src: ./templates/certbot-renew.sh.js
    dest: /usr/local/bin/certbot-renew
    owner: root
    group: root
    mode: '0755'

- name: Run cert renewal script
  ansible.builtin.shell: /usr/local/bin/certbot-renew

- name: Add cert renewal script to cron if it isn't already
  ansible.builtin.lineinfile:
    path: /etc/crontab
    line: '1  2  *  *  * root /usr/local/bin/certbot-renew'
    regexp: '^1  2  *  *  * root /usr/local/bin/certbot-renew$'

- name: Start and enable haproxy
  ansible.builtin.systemd:
    name: haproxy.service
    state: started
    enabled: yes  