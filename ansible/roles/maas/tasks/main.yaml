- name: Enable epel
  become: true
  yum:
    name: epel-release
    state: present

- name: Install maas and ansible requirements
  become: true
  yum:
    name:
    - postgresql
    - postgresql-server
    - python3-pip
    - snapd
    state: present

- name: Start snapd
  become: true
  ansible.builtin.systemd:
    name: snapd
    enabled: yes
    state: started

# NOTE: THIS NEEDS sudo postgresql-setup --initdb
# Possibly creates: /var/lib/pgsql/data

- name: Start postgresql
  become: true
  ansible.builtin.systemd:
    name: postgresql
    enabled: yes
    state: started

- name: Install maas
  become: true
  community.general.snap:
    name:
      - maas

- name: Install postgres python package
  become: true
  pip:
    name: psycopg2-binary

- name: Create a new database for maas
  become: true
  become_user: postgres
  community.postgresql.postgresql_db:
    name: maas

- name: Create user for maas to use in database
  become: true
  become_user: postgres
  community.postgresql.postgresql_user:
    db: maas
    name: maas
    password: "{{ maas_postgress_password }}"
    comment: maas application user
    priv: "ALL"

- name: Check if maas is configured
  become: true
  shell: snap run maas status
  register: maas_status
  ignore_errors: true

- name: Configure maas
  become: true
  when: maas_status.stdout == "MAAS is not configured"
  shell: snap run maas init region+rack --database-uri "postgres://maas:{{ maas_postgress_password }}@localhost/maas"
  args:
    stdin: "http://192.168.13.13:5240/MAAS\n"  # This is hacky. maas init prompts with a hostname for the server

- name: Allow port - HTTP web interface for MaaS
  become: true
  ansible.posix.firewalld:
    permanent: yes
    port: 5240/tcp
    state: enabled

- name: Allow port - MAAS rack HTTP communication
  become: true
  ansible.posix.firewalld:
    port: 5248/tcp
    permanent: yes
    state: enabled

- name: Allow port tcp - Reserved for internal MAAS services.
  become: true
  ansible.posix.firewalld:
    permanent: yes
    port: 5241-5247/tcp
    state: enabled

- name: Allow port udp - Reserved for internal MAAS services.
  become: true
  ansible.posix.firewalld:
    permanent: yes
    port: 5241-5247/udp
    state: enabled

- name: Allow port tcp - Reserved for region workers (RPC)
  become: true
  ansible.posix.firewalld:
    permanent: yes
    port: 5250-5270/tcp
    state: enabled

- name: Allow port udp - Reserved for region workers (RPC)
  become: true
  ansible.posix.firewalld:
    permanent: yes
    port: 5250-5270/udp
    state: enabled
