apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: frigate
spec:
  interval: 1h
  chart:
    spec:
      chart: frigate
      version:  7.8.0
      sourceRef:
        kind: HelmRepository
        name: blakeshome-charts
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    strategyType: Recreate
    image:
      repository: ghcr.io/blakeblackshear/frigate
      tag: 0.17.0-beta1
      pullPolicy: IfNotPresent
    imagePullSecrets: []
    env: []
    envFromSecrets:
      - frigate-rstp-credentials
    coral:
      enabled: false
      hostPath: /dev/apex_0
    gpu:
      nvidia:
        enabled: false
        runtimeClassName: null
    extraVolumes:
      - name: recording-storage
        hostPath:
          path: /store/frigate
    extraVolumeMounts:
      - mountPath: /media/frigate
        name: recording-storage
    shmSize: 1Gi
    config: |
      mqtt:
        host: mqtt.jsck.network
        port: 1883
        topic_prefix: frigate
        client_id: frigate
        stats_interval: 60
      record:
        enabled: true
        alerts:
          retain:
            days: 7
        detections:
          retain:
            days: 7
      ffmpeg:
        hwaccel_args: preset-intel-qsv-h264

      detectors:
        ov:
          type: openvino
          device: AUTO

      model:
        width: 300
        height: 300
        input_tensor: nhwc
        input_pixel_format: bgr
        path: /openvino-model/ssdlite_mobilenet_v2.xml
        labelmap_path: /openvino-model/coco_91cl_bkgr.txt

      cameras:
        garage1:
          ffmpeg:
            output_args:
              record: preset-record-generic-audio-aac
            inputs:
              - path: rtsp://{FRIGATE_RSTP_USERNAME}:{FRIGATE_RTSP_PASSWORD}@192.168.50.42:554/cam/realmonitor?channel=1&subtype=0
                roles:
                  - audio
                  - record
                  - detect

          motion:
            mask: []
          zones:
            driveway:
              coordinates:
                0,480,594,480,704,480,704,315,530,271,360,197,320,181,230,183,120,175,70,169,0,171,0,250
            front_door:
              coordinates: 364,187,474,185,704,235,704,313,328,201
        backdoor1:
          ffmpeg:
            output_args:
              record: preset-record-generic-audio-aac
            inputs:
              - path: rtsp://{FRIGATE_RSTP_USERNAME}:{FRIGATE_RTSP_PASSWORD}@192.168.50.43:554/cam/realmonitor?channel=1&subtype=0
                roles:
                  - audio
                  - record
                  - detect

          motion:
            mask:
              - 487,0,362,44,120,53,0,59,0,0
          zones:
            backdoor:
              coordinates: 361,52,451,0,570,0,704,47,704,480,0,480,0,77,124,51
        backyard1:
          ffmpeg:
            output_args:
              record: preset-record-generic-audio-aac
            inputs:
              - path: rtsp://{FRIGATE_RSTP_USERNAME}:{FRIGATE_RTSP_PASSWORD}@192.168.50.44:554/cam/realmonitor?channel=1&subtype=0
                roles:
                  - audio
                  - record
                  - detect

          motion: {}
          zones:
            deck:
              coordinates: 704,480,0,480,0,375,44,305,466,331,630,229
            yard:
              coordinates: 232,325,482,333,608,231,704,175,704,67,322,69,52,299
      snapshots:
        enabled: true
        retain:
          default: 60
      semantic_search:
        enabled: True
        reindex: False
      objects:
        # Optional: list of objects to track from labelmap.txt (default: shown below)
        track:
          - person
          - bicycle
          - car
          - motorcycle
          - bus
          - cat
          - dog
          - hot dog
    probes:
      liveness:
        enabled: true
        initialDelaySeconds: 30
        failureThreshold: 5
        timeoutSeconds: 10
      readiness:
        enabled: true
        initialDelaySeconds: 30
        failureThreshold: 5
        timeoutSeconds: 10
      startup:
        enabled: false
        failureThreshold: 30
        periodSeconds: 10
    service:
      type: LoadBalancer
      port: 5000
    ingress:
      enabled: false
      ingressClassName: tailscale
      annotations: {}
      hosts:
        - host: frigate
          paths:
            - /
      tls:
        - hosts:
            - frigate
    persistence:
      config:
        enabled: true
        accessMode: ReadWriteOnce
        size: 32Gi
        skipuninstall: false
    resources:
      requests:
        cpu: 200m
        memory: 128Mi
    securityContext:
      privileged: true
    nodeSelector: {}
    tolerations: []
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: app
                  operator: In
                  values:
                    - bulk-datastore
    podAnnotations: {}
