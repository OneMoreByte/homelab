apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
spec:
  interval: 1h
  timeout: 30m
  chartRef:
    kind: OCIRepository
    name: immich
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      main:
        containers:
          main:
            image:
              tag: v2.0.0
            env:
              REDIS_HOSTNAME: "immich-valkey"
              UID: 11337
              PID: 11337
              DB_HOSTNAME: '{{ .Release.Name }}-pg-cluster-rw'
              DB_DATABASE_NAME: immich
              DB_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: immich-db-secret
                    key: username
              DB_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: immich-db-secret
                    key: password

    defaultPodOptions:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - bulk-datastore
      securityContext:
        runAsUser: 11337
        runAsGroup: 11337
        fsGroup: 11337

    persistence:
      data:
        enabled: false
      library:
        enabled: true
        type: hostPath
        hostPath: /var/mnt/fast-store/k8s-hostpath/immich
        advancedMounts:
          main:
            main:
              - path: /data
      syncthing-library:
        enabled: true
        type: hostPath
        hostPath: /var/mnt/store/backups/syncthings/Pictures

    immich:
      metrics:
        enabled: true
      persistence:
        library:
          existingClaim: "not-used"


      configuration: {}


    server:
      enabled: true
      ingress:
        main:
          enabled: true
          annotations:
            traefik.ingress.kubernetes.io/router.tls: 'true'
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
          hosts:
            - host: photos.jackhil.de
              paths:
                - path: /
          tls:
            - hosts:
                - photos.jackhil.de
              secretName: photos.jackhil.de-cert

      persistence:
        data:
          enabled: false
          advancedMounts:
            main:
              main:
                - path: /unused
        config:
          enabled: true
          type: secret
          name: immich-config
    machine-learning:
      enabled: true
      controllers:
        main:
          containers:
            main:
              securityContext:
                privileged: true
              env:
                TRANSFORMERS_CACHE: /cache
                NVIDIA_DRIVER_CAPABILITIES: all
      persistence:
        cache:
          enabled: true
          size: 16Gi
          type: persistentVolumeClaim
          accessMode: ReadWriteMany

---
