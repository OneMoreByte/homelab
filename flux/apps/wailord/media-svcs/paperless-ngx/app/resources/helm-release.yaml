apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: paperless-ngx
spec:
  interval: 1h
  timeout: 15m
  chartRef:
    kind: OCIRepository
    name: paperless-ngx
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      repository: ghcr.io/paperless-ngx/paperless-ngx
      pullPolicy: IfNotPresent
      tag: 2.18.2
    env:
      TZ: UTC
      PAPERLESS_SECRET_KEY:
        secretKeyRef:
          name: paperless-secret-key
          key: key
      A_REDIS_PASSWORD:
        secretKeyRef:
          name: paperless-ngx-redis
          key: redis-password
      PAPERLESS_REDIS: redis://paperless:$(A_REDIS_PASSWORD)@paperless-ngx-valkey
      PAPERLESS_ENABLE_ALLAUTH: true
      PAPERLESS_AUTO_LOGIN: true
      PAPERLESS_AUTO_CREATE: true
      PAPERLESS_DBENGINE: postgresql
      PAPERLESS_DBHOST: paperless-pg-cluster-rw
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER:
        secretKeyRef:
          name: paperless-db-secret
          key: username
      PAPERLESS_DBPASS:
        secretKeyRef:
          name: paperless-db-secret
          key: password
    envFrom:
      - secretRef:
          name: paperless-oicd-settings
    service:
      main:
        ports:
          http:
            port: 8000
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: app
                  operator: In
                  values:
                    - bulk-datastore
    ingress:
      main:
        enabled: true
        annotations:
          traefik.ingress.kubernetes.io/router.tls: 'true'
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
        hosts:
          - host: paper.jackhil.de
            paths:
              - path: /
        tls:
          - secretName: paper.jackhil.de-cert
            hosts:
              - paper.jackhil.de
    persistence:
      data:
        enabled: true
        retain: true
        mountPath: /usr/src/paperless/data
        hostPath: /var/mnt/fast-store/k8s-hostpath/paperless/data
        type: hostPath
      media:
        enabled: true
        retain: true
        mountPath: /usr/src/paperless/media
        hostPath: /var/mnt/fast-store/k8s-hostpath/paperless/media
        type: hostPath
      export:
        enabled: true
        retain: true
        mountPath: /usr/src/paperless/export
        hostPath: /var/mnt/fast-store/k8s-hostpath/paperless/export
        type: hostPath
      consume:
        enabled: true
        retain: true
        mountPath: /usr/src/paperless/consume
        hostPath: /var/mnt/fast-store/k8s-hostpath/paperless/consume
        type: hostPath
    redis:
      enabled: false
